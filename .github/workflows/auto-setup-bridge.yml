name: ğŸ¤– DAK CHAIN - Auto-Setup Inter-PC Bridge

# Trigger: Cuando PC1 envÃ­a archivo de setup
on:
  push:
    paths:
      - '.dak-chain/setup-bridge.json'
      - '.dak-chain/setup-prompt.md'

jobs:
  auto-setup-agent:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Verify authorized source
        id: verify
        run: |
          echo "Verificando origen autorizado..."

          # Lee whitelist de repos autorizados
          if [ -f .dak-chain/authorized-sources.json ]; then
            echo "âœ… Whitelist encontrada"
            cat .dak-chain/authorized-sources.json
          else
            echo "âš ï¸ No hay whitelist configurada - Permitiendo cualquier origen (INSEGURO)"
          fi

          echo "verified=true" >> $GITHUB_OUTPUT

      - name: ğŸ“– Read setup instructions
        id: instructions
        run: |
          echo "=== Setup Instructions ==="
          cat .dak-chain/setup-bridge.json

          echo ""
          echo "=== Agent Prompt ==="
          cat .dak-chain/setup-prompt.md

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "Instalando dependencias..."
          npm install -g json

      - name: ğŸ§¬ Create agent directory structure
        run: |
          echo "Creando estructura de agentes..."
          mkdir -p .claude/.agents
          mkdir -p .claude/skills

          # Verificar si ya existe el agente
          if [ -f .claude/.agents/inter-pc-bridge.md ]; then
            echo "âš ï¸ Agente inter-pc-bridge ya existe - Actualizando..."
          else
            echo "âœ… Creando nuevo agente inter-pc-bridge..."
          fi

      - name: ğŸ¤– Generate agent from template
        run: |
          # Lee configuraciÃ³n
          SOURCE_PC=$(cat .dak-chain/setup-bridge.json | json source_pc)
          TARGET_PC=$(cat .dak-chain/setup-bridge.json | json target_pc)
          BLOCKCHAIN_URL=$(cat .dak-chain/setup-bridge.json | json blockchain_url)

          echo "Generando agente para:"
          echo "  Source: $SOURCE_PC"
          echo "  Target: $TARGET_PC"
          echo "  Blockchain: $BLOCKCHAIN_URL"

          # Crea agente usando template + instrucciones
          cat > .claude/.agents/inter-pc-bridge.md << 'AGENT_EOF'
# ğŸŒ‰ Inter-PC Bridge Agent

**Version**: 1.0 Auto-Generated
**Created**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Source**: $SOURCE_PC
**Target**: $TARGET_PC

---

## ğŸ¯ Purpose

Agent auto-created by DAK CHAIN Auto-Bootstrapping system.

Enables bidirectional communication between:
- **PC1**: $SOURCE_PC
- **PC2**: $TARGET_PC

Via GitHub as nervous system.

---

## ğŸ§¬ Capabilities

### 1. Read PC1 Blockchain Viviente

```yaml
Source Repo: $BLOCKCHAIN_URL

Files to read:
  - .claude/skills/blockchain-viviente-visual-map/SKILL.md
  - .claude/.agent-registry.json
  - .claude/knowledge/*.md
  - README.md
```

### 2. Detect Consultations

```yaml
Monitor GitHub Issues with tag:
  [PC1-CONSULTA]

Extract information:
  - NÃšMERO+LETRA+CAPA mentioned
  - Context provided
  - Specific question
```

### 3. Translate Patterns

```yaml
Workflow:
  1. Find equivalent node in PC2
  2. Read PC2 implementation
  3. Adapt pattern PC1 â†’ PC2
  4. Generate adapted code
```

### 4. Respond Automatically

```yaml
Create Issue in PC1 repo:
  Tag: [PC2-RESPUESTA]
  Content:
    - Pattern found
    - PC2 implementation details
    - Adapted code for PC1
    - Documentation links
```

---

## ğŸ› ï¸ Tools Available

- GitHub MCP (26 tools)
- GitHub CLI (gh)
- Task(Explore) for code analysis
- Context7 for updated docs

---

## ğŸ“Š Communication Protocol

### Inbound (PC1 â†’ PC2)

```markdown
Title: [PC1-CONSULTA] <topic>

Body:
\`\`\`yaml
De: PC1 (<app-name>)
Para: PC2 (<app-name>)

Consulta: <question>

Contexto PC1:
  - CAPA: <capa>
  - Feature: <feature>
  - Tech: <tech-stack>

Â¿QuÃ© pattern usas?
\`\`\`
```

### Outbound (PC2 â†’ PC1)

```markdown
Title: [PC2-RESPUESTA] Re: <topic>

Body:
\`\`\`yaml
De: PC2 (<app-name>)
Para: PC1 (<app-name>)

Pattern encontrado: <NUMERO+LETRA+CAPA>

ImplementaciÃ³n PC2:
  <details>

AdaptaciÃ³n sugerida PC1:
  <adapted-details>

CÃ³digo adaptado:
  <code-snippet>
\`\`\`
```

---

## ğŸš€ Auto-Activation

Triggers:
- New Issue with [PC1-CONSULTA] tag
- Webhook from PC1 repo
- Scheduled polling (every 5 min)

---

## ğŸ”’ Security

Permissions:
- âœ… Read: PC1 blockchain viviente
- âœ… Write: GitHub Issues only
- âŒ NO: Modify PC2 code
- âŒ NO: Access filesystem

Whitelist:
- Check .dak-chain/authorized-sources.json

---

**Auto-created by**: DAK CHAIN Auto-Bootstrapping System
**Blockchain**: $BLOCKCHAIN_URL
**Protocol**: NÃšMERO+LETRA+CAPA
AGENT_EOF

          echo "âœ… Agente creado en .claude/.agents/inter-pc-bridge.md"

      - name: ğŸ“ Update agent registry
        run: |
          # Actualizar o crear registry
          if [ ! -f .claude/.agent-registry.json ]; then
            echo '{"agents": []}' > .claude/.agent-registry.json
          fi

          # Agregar agente al registry (si no existe)
          cat .claude/.agent-registry.json | \
          json -e 'this.agents = this.agents || []' | \
          json -e 'this.agents.push({
            "id": "inter-pc-bridge",
            "name": "Inter-PC Bridge",
            "version": "1.0",
            "auto_created": true,
            "created_at": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
          })' > .claude/.agent-registry-temp.json

          mv .claude/.agent-registry-temp.json .claude/.agent-registry.json

          echo "âœ… Registry actualizado"

      - name: ğŸ’¾ Commit agent to repo
        run: |
          git config user.name "DAK CHAIN Bot"
          git config user.email "bot@dak-chain.ai"

          git add .claude/.agents/inter-pc-bridge.md
          git add .claude/.agent-registry.json

          git commit -m "ğŸ¤– Auto-created inter-pc-bridge agent

Auto-generated by DAK CHAIN Auto-Bootstrapping System

Agent capabilities:
- Read PC1 blockchain viviente
- Detect [PC1-CONSULTA] Issues
- Translate patterns PC1 â†” PC2
- Respond automatically

Protocol: NÃšMERO+LETRA+CAPA

ğŸ§¬ Generated with DAK CHAIN IA Framework
" || echo "No changes to commit"

          git push || echo "No changes to push"

      - name: ğŸ”” Notify PC1 via Issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extraer repo PC1 de setup
          PC1_REPO=$(cat .dak-chain/setup-bridge.json | json source_repo || echo "")

          if [ -n "$PC1_REPO" ]; then
            gh issue create \
              --repo "$PC1_REPO" \
              --title "âœ… PC2 Bridge Agent Auto-Created" \
              --body "## ğŸ¤– Auto-Setup Completado

Agente \`inter-pc-bridge\` instalado automÃ¡ticamente en PC2.

**Status**: âœ… Activo
**Created**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Protocol**: NÃšMERO+LETRA+CAPA

### Capabilities:
- ğŸ“– Lee blockchain viviente PC1
- ğŸ” Detecta Issues [PC1-CONSULTA]
- ğŸ”„ Traduce patterns PC1 â†” PC2
- ğŸ’¬ Responde automÃ¡ticamente

### Ready for:
ComunicaciÃ³n bidireccional PC1 â†” PC2

---

ğŸ§¬ Auto-generated by DAK CHAIN IA Framework" || echo "No se pudo crear Issue de notificaciÃ³n"
          else
            echo "âš ï¸ No se especificÃ³ source_repo - Saltando notificaciÃ³n"
          fi

      - name: ğŸ“Š Summary
        run: |
          echo "=== Auto-Setup Completado ==="
          echo ""
          echo "âœ… Agente inter-pc-bridge creado"
          echo "âœ… Registry actualizado"
          echo "âœ… Committed a repo"
          echo "âœ… NotificaciÃ³n enviada a PC1"
          echo ""
          echo "ğŸŒ‰ PC2 ahora puede comunicarse con PC1"
          echo "ğŸ“¡ Esperando Issues con tag [PC1-CONSULTA]"
